- name: Deploy Pillar Strength API
  hosts: pillarstrength_pi
  connection: local
  become: true
  gather_facts: true


  tasks:
    - name: Ensure app directory exists
      file:
        path: "{{ app_dir }}"
        state: directory
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"

    - name: Upload jar
      copy:
        src: "{{ playbook_dir }}/../../../apps/api/pillar-strength/target/pillar-strength-0.0.1-SNAPSHOT.jar"
        dest: "{{ app_dir }}/{{ jar_name }}"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0755"

    - name: Upload application-prod.properties
      template:
        src: ../templates/application-prod.properties.j2
        dest: "{{ app_dir }}/application-prod.properties"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0644"

    - name: Upload .env (secrets)
      copy:
        content: |
          DB_URL={{ lookup('env','DB_URL') }}
          DB_USER={{ lookup('env','DB_USER') }}
          DB_PASSWORD={{ lookup('env','DB_PASSWORD') }}
          SUPABASE_ISSUER_URI={{ lookup('env','SUPABASE_ISSUER_URI') }}
          SUPABASE_JWKS_URI={{ lookup('env','SUPABASE_JWKS_URI') }}
        dest: "{{ app_dir }}/.env"
        owner: "{{ app_user }}"
        group: "{{ app_group }}"
        mode: "0600"

    - name: Restart service
      systemd:
        name: "{{ app_name }}"
        state: restarted
        daemon_reload: true

    - name: Wait for port
      wait_for:
        host: 127.0.0.1
        port: "{{ server_port }}"
        delay: 1
        timeout: 30

    - name: Health check
      uri:
        url: "http://127.0.0.1:{{ server_port }}/actuator/health"
        status_code: 200
      register: health
      retries: 10
      delay: 2
      until: health.status == 200

